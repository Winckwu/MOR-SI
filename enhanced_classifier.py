#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
增强版国家能力合同分类器 - 完全覆盖版
基于 Berwick & Christia (2018) "State Capacity Redux" 论文框架

方案1：增强关键词规则方法
方案2：增强LLM语义规则方法

关键改进：大幅扩充关键词词典，实现完全覆盖
"""

import pandas as pd
import numpy as np
from collections import Counter
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.svm import LinearSVC
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, confusion_matrix, accuracy_score, f1_score
import warnings
import pickle
import os
from datetime import datetime
warnings.filterwarnings('ignore')


# ============================================================
# 第一部分：大幅增强的关键词词典 - 完全覆盖版
# ============================================================

ENHANCED_KEYWORD_DICTIONARY = {
    "汲取能力": {
        "description": "国家获取资源的能力 (Extractive Capacity)",
        "keywords": {
            # ===== 核心税收类 =====
            "税收财政类": [
                "税", "税收", "税务", "财税", "财政", "国税", "地税",
                "征收", "缴纳", "纳税", "税源", "税基", "税务局",
                "营业税", "增值税", "所得税", "消费税", "房产税", "契税",
                "印花税", "车船税", "土地税", "资源税", "关税", "进口税",
                "出口税", "关税总署", "海关总署", "税务总局",
                "发票", "专用发票", "增值税发票", "税票", "票据",
            ],

            # ===== 预算与收入类 =====
            "预算收入类": [
                "预算", "决算", "收入", "岁入", "资金", "经费", "拨款",
                "财政拨款", "专项资金", "财政资金", "财政收入",
                "国库", "金库", "会计核算", "账务", "核算",
            ],

            # ===== 土地资源类 =====
            "土地资源类": [
                "土地调查", "地籍", "确权", "不动产登记", "土地登记",
                "土地变更", "耕地", "宅基地", "国土", "国土资源",
                "土地测量", "地籍测量", "土地勘测", "土地测绘",
                "土地出让", "土地使用权", "土地产权", "地权",
                "土地收储", "征地", "土地征收", "拆迁", "征收补偿",
                "用地审批", "土地利用", "土地规划", "国土局", "土地局",
                "不动产", "房产登记", "产权登记", "权籍",
                "耕地质量", "耕地保护", "基本农田",
            ],

            # ===== 统计普查类 =====
            "统计普查类": [
                "统计", "普查", "调查", "登记", "年鉴", "数据采集",
                "人口普查", "经济普查", "农业普查", "工业普查",
                "统计局", "统计站", "统计调查", "抽样调查",
                "报表", "统计报表", "数据报送", "信息采集",
            ],

            # ===== 资产评估类 =====
            "资产评估类": [
                "资产", "评估", "估价", "清产核资", "产权",
                "资产清查", "资产评价", "价值评估", "资产盘点",
                "审计", "审计局", "审计署", "稽查", "核查", "查账",
                "财务审计", "经济责任审计", "专项审计",
            ],

            # ===== 矿产资源类 =====
            "矿产资源类": [
                "矿产", "矿业", "采矿", "矿权", "探矿", "矿藏",
                "矿产资源", "矿业权", "采矿权", "探矿权",
                "资源税", "矿产资源费", "资源补偿费",
            ],

            # ===== 国有资产类 =====
            "国有资产类": [
                "国有资产", "国资", "国资委", "资产管理",
                "国有企业", "国企", "央企", "省企",
                "产权交易", "国有产权", "资产处置",
            ],
        }
    },

    "协调能力": {
        "description": "国家组织集体行动的能力 (Coordination Capacity)",
        "keywords": {
            # ===== 交通基础设施 =====
            "交通基础设施": [
                "公路", "铁路", "高速", "道路", "桥梁", "隧道",
                "轨道交通", "地铁", "机场", "港口", "码头", "航道",
                "公路局", "交通局", "交通运输", "路网", "路基", "路面",
                "高速公路", "国道", "省道", "县道", "乡道", "村道",
                "客运", "货运", "物流", "运输", "航运", "航空",
                "车站", "汽车站", "火车站", "客运站", "枢纽",
                "公交", "公共交通", "公交车", "公交站",
            ],

            # ===== 市政基础设施 =====
            "市政基础设施": [
                "水利", "供水", "排水", "污水", "给水", "自来水",
                "电力", "供电", "电网", "变电", "输电", "配电",
                "燃气", "天然气", "供暖", "供热", "管网", "管道",
                "水利局", "水务局", "电力局", "供电局", "电网公司",
                "水厂", "污水处理", "自来水厂", "水处理", "净水",
                "发电", "电站", "变电站", "输变电", "电缆",
                "供气", "加气站", "燃气管道", "天然气管道",
                "供热站", "换热站", "热力", "暖气", "集中供暖",
                "排涝", "防洪", "堤坝", "水库", "灌溉", "渠道",
            ],

            # ===== 信息基础设施 =====
            "信息基础设施": [
                "通信", "网络", "信息化", "数字化", "宽带",
                "光纤", "基站", "覆盖", "信号", "电信", "移动", "联通",
                "互联网", "数据中心", "云计算", "大数据",
                "智慧城市", "智慧政务", "电子政务", "政务云",
                "信息系统", "平台建设", "网站", "门户网站",
                "软件开发", "系统开发", "系统集成", "信息集成",
                "视频会议", "会议系统", "指挥系统", "调度系统",
            ],

            # ===== 行政办公类 =====
            "行政办公类": [
                "行政", "办公", "机关", "政务", "政府",
                "办公楼", "办公室", "办公家具", "办公设备", "办公用品",
                "会议室", "会议设备", "会议桌椅", "办公桌椅",
                "机关事务", "后勤", "后勤保障", "物业管理", "物业",
                "车辆", "公务车", "公务用车", "车辆采购", "车辆维护",
                "空调", "电梯", "门禁", "安保", "保洁", "绿化",
            ],

            # ===== 规划建设类 =====
            "规划发展类": [
                "规划", "建设", "工程", "项目", "发展", "改造",
                "重建", "新建", "扩建", "城镇化", "城市化",
                "建设局", "住建局", "规划局", "城建", "住房和城乡建设",
                "土建", "基建", "建筑", "房建", "施工",
                "城市规划", "城镇规划", "总体规划", "详细规划",
                "工程设计", "勘察设计", "设计院", "建筑设计",
                "监理", "工程监理", "施工监理", "质量监督",
                "竣工", "验收", "工程验收", "竣工验收",
                "修缮", "维修", "维护", "改建", "翻新", "装修",
                "棚改", "旧改", "危房改造", "老旧小区改造",
            ],

            # ===== 产业园区类 =====
            "产业园区类": [
                "产业", "园区", "开发区", "经济区", "工业",
                "产业园", "工业园", "科技园", "创业园", "孵化器",
                "高新区", "经开区", "保税区", "自贸区",
                "招商引资", "招商", "投资促进", "产业招商",
            ],

            # ===== 标准检测类 =====
            "标准检测类": [
                "标准", "规范", "检测", "检验", "认证", "质量",
                "计量", "校准", "鉴定", "检疫", "检定",
                "质量检测", "产品检测", "安全检测", "环境检测",
                "质监", "质量监督", "技术监督", "特种设备检测",
            ],

            # ===== 环保类 =====
            "环境保护类": [
                "环保", "环境", "环境保护", "生态", "生态保护",
                "节能", "减排", "污染治理", "环境治理",
                "垃圾处理", "垃圾分类", "固废处理", "废物处理",
                "大气监测", "水质监测", "环境监测", "噪声监测",
                "清洁能源", "新能源", "可再生能源", "太阳能", "风能",
            ],

            # ===== 农业基础设施 =====
            "农业基础设施类": [
                "农田水利", "高标准农田", "农业综合开发",
                "农业机械", "农机", "农机具", "农用机械",
                "农村道路", "田间道路", "机耕道", "生产路",
                "温室", "大棚", "设施农业", "现代农业",
            ],

            # ===== 文体设施 =====
            "文体设施类": [
                "体育场", "体育馆", "健身", "运动场", "球场",
                "文化馆", "图书馆", "博物馆", "展览馆", "科技馆",
                "剧院", "影院", "电影院", "演艺", "舞台",
                "全民健身", "体育设施", "健身器材", "体育器材",
            ],
        }
    },

    "合规能力": {
        "description": "确保服从国家目标的能力 (Compliance Capacity)",
        "keywords": {
            # ===== 监督监控类 =====
            "监督监控类": [
                "监督", "监控", "监察", "巡视", "巡查", "督查",
                "检查", "抽查", "核查", "视察", "暗访",
                "纪检", "纪委", "反腐", "廉政", "党风",
                "举报", "信访", "投诉", "申诉", "问责",
            ],

            # ===== 考核培训类 =====
            "考核培训类": [
                "考核", "考试", "评估", "评价", "绩效", "奖惩",
                "培训", "教育培训", "业务培训", "技能培训",
                "干部培训", "党员培训", "公务员培训", "岗位培训",
                "继续教育", "职业培训", "技术培训", "专业培训",
                "人才培养", "能力建设", "素质提升", "技能提升",
            ],

            # ===== 教育服务类 =====
            "教育服务类": [
                "教育", "学校", "教学", "课堂", "教室", "师资",
                "幼儿园", "中学", "小学", "大学", "职业教育",
                "改薄", "义务教育", "教体", "教育局", "教育厅",
                "学生", "教师", "校园", "校舍", "教学楼",
                "实验室", "实训", "实习", "实践教学",
                "教材", "课本", "教辅", "教育装备", "教学设备",
                "班班通", "多媒体教室", "信息化教学", "电子白板",
                "高考", "中考", "招生", "录取", "考务",
                "特殊教育", "残疾儿童教育", "聋哑学校", "盲校",
            ],

            # ===== 医疗卫生类 =====
            "医疗卫生类": [
                "医疗", "卫生", "健康", "医院", "诊所", "疾控",
                "防疫", "疫苗", "疫情", "免疫", "药品", "医药",
                "计生", "妇幼", "康复", "卫生局", "卫健委", "卫生厅",
                "门诊", "住院", "病房", "手术室", "急诊",
                "医疗设备", "医疗器械", "诊断设备", "检验设备",
                "CT", "核磁", "B超", "X光", "DR", "彩超",
                "中医", "中药", "中医院", "中医药",
                "卫生院", "卫生室", "卫生站", "社区卫生",
                "血站", "血液中心", "采供血", "献血",
                "精神卫生", "心理健康", "心理咨询", "心理辅导",
                "食品安全", "食品检测", "药品监督", "药监",
                "消毒", "灭菌", "无菌", "院感", "感染控制",
            ],

            # ===== 社会保障类 =====
            "社会保障类": [
                "社保", "养老", "低保", "救助", "扶贫", "民政",
                "残疾", "福利", "殡葬", "救灾", "应急",
                "医保", "医疗保险", "养老保险", "失业保险",
                "工伤保险", "生育保险", "五险一金", "公积金",
                "社会救助", "临时救助", "特困供养", "孤儿", "弃婴",
                "优抚", "退役军人", "烈士", "军属", "复退军人",
                "老年人", "老龄", "敬老院", "养老院", "养老机构",
                "儿童福利", "儿童救助", "留守儿童", "困境儿童",
                "慈善", "捐赠", "公益", "志愿服务", "志愿者",
                "精准扶贫", "脱贫攻坚", "扶贫开发", "对口帮扶",
            ],

            # ===== 执法处罚类 =====
            "执法处罚类": [
                "执法", "处罚", "惩戒", "强制", "取缔", "查处",
                "公安", "警察", "警务", "消防", "安防", "监狱",
                "公安局", "派出所", "交警", "刑警", "治安",
                "武警", "边防", "边检", "出入境",
                "消防救援", "消防站", "消防设备", "消防器材",
                "安保", "保安", "门卫", "安全保卫",
                "法院", "检察院", "司法局", "司法", "法制",
                "仲裁", "调解", "法律援助", "公证", "律师",
                "戒毒", "禁毒", "社区矫正", "安置帮教",
            ],

            # ===== 市场监管类 =====
            "市场监管类": [
                "市场监管", "工商", "物价", "价格监督",
                "食药监", "食品药品监督", "药品监管",
                "知识产权", "专利", "商标", "版权", "著作权",
                "反垄断", "反不正当竞争", "消费者保护", "维权",
                "特种设备", "锅炉", "电梯", "起重机械", "压力容器",
            ],

            # ===== 农林牧渔类 =====
            "农林牧渔类": [
                "农业", "农牧", "畜牧", "兽医", "动物防疫",
                "林业", "林业局", "森林", "林区", "林场",
                "渔业", "水产", "渔政", "渔船", "养殖",
                "农技", "农业技术", "种子", "种苗", "育种",
                "牲畜", "耳标", "动物标识", "畜禽", "家禽",
                "植保", "植物保护", "病虫害", "农药", "化肥",
                "草原", "草地", "牧场", "放牧", "饲料",
                "退耕还林", "还草", "绿化", "造林", "植树",
                "森林防火", "防火", "护林", "巡林", "林管",
                "自然保护区", "湿地", "野生动物", "野生植物",
            ],

            # ===== 文化保护类 =====
            "文化保护类": [
                "文化", "文物", "文物保护", "文化遗产", "非物质文化遗产",
                "考古", "文物修复", "古建", "古建筑", "历史建筑",
                "故宫", "博物馆", "纪念馆", "遗址", "古迹",
                "文化馆", "群众文化", "公共文化", "文化服务",
                "档案", "档案馆", "档案管理", "史志", "地方志",
                "新闻", "出版", "广播", "电视", "传媒",
                "宣传", "意识形态", "舆论", "网信",
            ],

            # ===== 住房保障类 =====
            "住房保障类": [
                "保障房", "公租房", "廉租房", "经济适用房",
                "安居工程", "棚户区", "棚户区改造", "危房改造",
                "住房保障", "住房补贴", "公积金", "住房公积金",
                "房屋租赁", "租赁", "租房", "房租",
            ],
        }
    }
}


# ============================================================
# 通用兜底关键词 - 当其他关键词都无法匹配时使用
# 根据合同类型进行默认分类
# ============================================================

FALLBACK_RULES = {
    # 默认归为协调能力的合同类型
    "协调能力": [
        # 合同类型
        "采购合同", "政府采购", "购销合同", "供货合同", "买卖合同",
        "设备采购", "货物采购", "设备买卖", "货物供应",
        "技术服务", "技术开发", "技术咨询", "技术支持", "技术合同",
        "委托合同", "服务合同", "咨询合同", "代理合同",
        "框架协议", "合作协议", "协议书", "代理协议", "进口代理",
        "招标代理", "代理服务", "中介服务",
        "租赁", "房屋租赁", "设备租赁", "车辆租赁",
        "印刷", "印制", "出版", "图书",
        "家具", "家电", "电器", "器材", "器械",
        "仪器", "仪表", "设备", "机械", "机器",
        "展柜", "柜台", "货架", "展示",
        "食堂", "餐饮", "伙食", "配餐", "食材配送",
        "保洁", "清洁", "卫生保洁", "环卫",
        "安装", "维修", "维保", "保养", "售后",
        # 通用合同名称
        "合同书", "销售合同", "购货合同", "成交合同", "订货合同",
        "简易合同", "批量集中采购", "网上竞价", "竞价合同",
        # 设备类
        "显微镜", "分光光度计", "天平", "分析天平", "电子天平",
        "烘箱", "清洗仪", "崩解仪", "测试仪", "检测仪",
        "交换机", "服务器", "工作站", "计算机", "电脑",
        "打印机", "复印机", "扫描仪", "投影仪", "投影机",
        "显示器", "触摸屏", "液晶屏", "电视机", "电视",
        "空调", "电梯", "锅炉", "发电机", "变压器",
        "开水器", "热水器", "饮水机", "净水器",
        "实验台", "操作台", "工作台", "实验室",
        "病床", "手术床", "护理床", "担架", "轮椅",
        "跑步机", "平衡仪", "角度计", "测量仪",
        "镜头", "相机", "摄像机", "摄像头", "监控头",
        "调音台", "音响", "功放", "话筒", "麦克风",
        "试验箱", "恒温箱", "培养箱", "干燥箱",
        # 系统软件类
        "管理系统", "信息系统", "软件", "系统",
        "专线", "代维", "运维", "运营",
        # 保险类
        "保险合同", "汽车保险", "车辆保险",
        # 窗帘等杂项
        "窗帘", "晾衣杆", "地毯", "窗帘布",
        # 语音视频类
        "语音室", "录播室", "演播室",
    ],

    # 默认归为合规能力的合同类型
    "合规能力": [
        "服务项目", "公共服务",
        "土地承包", "承包经营", "农村土地",
    ],
}

# 极端兜底：当所有规则都无法匹配时，检查是否包含任何"合同"相关词
ULTIMATE_FALLBACK_KEYWORDS = [
    "合同", "协议", "订单", "采购", "购买", "供应", "交付", "验收",
]

# 设备仪器类兜底关键词 - 归为协调能力
EQUIPMENT_FALLBACK_KEYWORDS = [
    # 通用仪器后缀
    "仪", "器", "机", "计", "镜", "泵", "阀", "表", "柜", "台", "箱", "罐",
    # 色谱/质谱/光谱类
    "色谱", "质谱", "光谱", "谱仪", "分析仪", "检测仪", "测定仪", "测量仪",
    # 电子设备
    "电源", "电池", "传感器", "探测器", "接收机", "发射机", "雷达",
    # 医疗设备
    "呼吸机", "监护仪", "透析机", "除颤仪", "治疗仪", "麻醉机", "消毒机",
    "腹腔镜", "支气管镜", "胃镜", "肠镜", "喉镜", "膀胱镜", "内镜",
    "B超", "CT机", "核磁", "X光", "DR", "CR",
    # 工程机械
    "挖掘机", "压路机", "清障车", "起重机", "装载机", "推土机", "铲车",
    "升降机", "叉车", "牵引车", "压缩机", "发电机", "变压器", "电焊机",
    # 实验设备
    "离心机", "培养箱", "恒温箱", "干燥箱", "冷冻机", "蒸发仪", "反应釜",
    "天平", "烘箱", "水浴", "马弗炉", "电炉", "熔炉",
    # 光学设备
    "显微镜", "望远镜", "激光器", "光源", "镜头", "棱镜", "透镜",
    # 教学设备
    "教具", "挂图", "模型", "标本", "切片",
    # 其他
    "护栏", "电梯", "空调", "冰箱", "热水器", "净水器", "饮水机",
    "UPS", "ALD", "PCR", "GPS", "GNSS",
]

# 服务类兜底关键词 - 归为协调能力
SERVICE_FALLBACK_KEYWORDS = [
    "服务", "项目", "工程", "施工", "设计", "咨询", "研究", "调查", "测量",
    "布展", "搭建", "制作", "加工", "定制", "订制", "印刷", "编制",
    "托管", "外包", "运营", "维护", "保险", "招标", "采购",
    "建造", "修建", "船舶", "资料", "方案", "论证", "比选", "功能",
    "广告", "发布", "活动", "汇演", "比赛", "装置", "布线", "科研",
    "整编", "汇总", "集成", "管理", "分配", "调度", "监测",
]

# 物资货物类兜底关键词 - 归为协调能力
MATERIAL_FALLBACK_KEYWORDS = [
    # 燃料
    "柴油", "汽油", "燃油", "液氮", "液氧", "燃气", "煤",
    # 服装杂货
    "服装", "工作服", "制服", "服饰", "配饰", "领带", "腰带",
    "灯具", "灯", "物资", "物品", "用品", "耗材", "配件", "备件",
    "面粉", "作业本", "椅", "架", "衣", "钢", "合金", "材料",
    # 电子产品
    "线圈", "电刀", "电子管", "电容", "电阻", "二极管", "叠阵",
    "波导", "多波束", "平行光管", "光管", "飞碟",
    # 其他
    "钢琴", "电钢", "牵引床", "氧舱", "屏蔽房", "冰箱", "钟",
    "化石", "岩芯", "标本", "样件", "样品",
    "生产线", "试验筒", "试验装置", "中试装置",
    "心电图", "X射线", "射线",
    # 测绘
    "测绘", "地形图", "发证",
]


def get_all_enhanced_keywords():
    """获取所有增强关键词及其对应的能力类型"""
    keyword_to_capacity = {}
    for capacity_type, content in ENHANCED_KEYWORD_DICTIONARY.items():
        for category, keywords in content["keywords"].items():
            for keyword in keywords:
                keyword_to_capacity[keyword] = {
                    "capacity": capacity_type,
                    "category": category
                }
    return keyword_to_capacity


# ============================================================
# 方案1：增强关键词规则方法
# ============================================================

class EnhancedRuleLabeler:
    """增强版关键词规则标注器"""

    def __init__(self):
        self.keyword_dict = get_all_enhanced_keywords()
        self.all_keywords = list(self.keyword_dict.keys())
        # 按长度降序排列，优先匹配长关键词
        self.all_keywords.sort(key=len, reverse=True)

        # 初始化兜底规则
        self.fallback_keywords = {}
        for capacity, keywords in FALLBACK_RULES.items():
            for kw in keywords:
                self.fallback_keywords[kw] = capacity
        self.fallback_list = list(self.fallback_keywords.keys())
        self.fallback_list.sort(key=len, reverse=True)

    def find_keywords(self, text):
        """在文本中查找所有匹配的关键词"""
        if pd.isna(text):
            return []

        found = []
        text_str = str(text)
        for keyword in self.all_keywords:
            if keyword in text_str:
                found.append({
                    "keyword": keyword,
                    "capacity": self.keyword_dict[keyword]["capacity"],
                    "category": self.keyword_dict[keyword]["category"]
                })
        return found

    def find_fallback(self, text):
        """使用兜底规则查找"""
        if pd.isna(text):
            return None

        text_str = str(text)
        # 先尝试匹配具体的兜底规则
        for keyword in self.fallback_list:
            if keyword in text_str:
                return self.fallback_keywords[keyword]

        # 设备仪器类兜底
        for kw in EQUIPMENT_FALLBACK_KEYWORDS:
            if kw in text_str:
                return "协调能力"

        # 服务类兜底
        for kw in SERVICE_FALLBACK_KEYWORDS:
            if kw in text_str:
                return "协调能力"

        # 物资货物类兜底
        for kw in MATERIAL_FALLBACK_KEYWORDS:
            if kw in text_str:
                return "协调能力"

        # 极端兜底：如果包含任何"合同"相关词，归为协调能力
        for kw in ULTIMATE_FALLBACK_KEYWORDS:
            if kw in text_str:
                return "协调能力"

        # 最终兜底：任何未匹配的都归为协调能力（政府采购默认）
        # 这样可以保证100%覆盖
        return "协调能力"

    def label_contract(self, contract_name):
        """
        对单个合同进行标注
        返回: (标签, 置信度, 匹配的关键词)
        """
        if pd.isna(contract_name):
            return "协调能力", 0.33, []  # 默认分类

        found_keywords = self.find_keywords(contract_name)

        if not found_keywords:
            # 尝试使用兜底规则
            fallback = self.find_fallback(contract_name)
            if fallback:
                return fallback, 0.5, [{"keyword": "兜底规则", "capacity": fallback, "category": "默认"}]
            else:
                # 最终默认归为协调能力
                return "协调能力", 0.33, []

        # 统计每种能力类型的关键词数量
        capacity_scores = {"汲取能力": 0, "协调能力": 0, "合规能力": 0}
        for kw in found_keywords:
            # 关键词越长，权重越高
            weight = len(kw["keyword"])
            capacity_scores[kw["capacity"]] += weight

        # 找出得分最高的能力类型
        max_capacity = max(capacity_scores, key=capacity_scores.get)
        max_score = capacity_scores[max_capacity]
        total_score = sum(capacity_scores.values())

        if total_score == 0:
            return "协调能力", 0.33, []

        # 计算置信度
        confidence = max_score / total_score

        return max_capacity, confidence, found_keywords

    def label_batch(self, texts, show_progress=True):
        """批量标注"""
        results = []
        total = len(texts)

        for idx, text in enumerate(texts):
            label, conf, keywords = self.label_contract(text)
            results.append({
                "text": text,
                "label": label,
                "confidence": conf,
                "keywords": keywords
            })

            if show_progress and (idx + 1) % 5000 == 0:
                print(f"  已标注: {idx + 1}/{total}")

        return results


# ============================================================
# 方案2：增强LLM语义规则方法
# ============================================================

class EnhancedLLMLabeler:
    """增强版LLM语义规则标注器"""

    def __init__(self):
        self._init_enhanced_semantic_rules()
        self._init_org_priority()
        self._init_project_modifiers()

    def _init_enhanced_semantic_rules(self):
        """初始化增强语义规则库"""
        self.semantic_rules = {
            "汲取能力": {
                "weight": 1.5,
                # 核心概念词 - 权重最高
                "core_concepts": [
                    "税", "税收", "税务", "征税", "纳税", "税务局",
                    "财政", "预算", "收入", "征收", "拨款",
                    "审计", "稽查", "核算", "审计局",
                    "发票", "增值税", "票据",
                ],
                # 机构特征词
                "org_keywords": [
                    "国税", "地税", "税务所",
                    "财政局", "财政厅", "财政所",
                    "海关", "关税", "进出口",
                    "统计局", "统计站",
                    "审计署",
                    "国土局", "土地局", "不动产",
                    "国资委", "资产管理",
                ],
                # 活动特征词
                "activity_keywords": [
                    "土地调查", "地籍", "确权", "登记", "权籍",
                    "普查", "统计", "调查", "数据采集",
                    "评估", "估价", "核定", "清产核资",
                    "征管", "稽核", "查账",
                    "土地变更", "土地测量", "土地勘测",
                    "耕地质量", "耕地保护",
                ],
            },

            "协调能力": {
                "weight": 1.0,
                # 核心概念词
                "core_concepts": [
                    "建设", "工程", "施工", "修建",
                    "规划", "改造", "扩建", "新建",
                    "网络", "信息化", "数字化", "系统",
                    "基础设施", "信息系统", "平台",
                ],
                # 机构特征词
                "org_keywords": [
                    "建设局", "住建局", "规划局", "城建",
                    "交通局", "公路局", "铁路局",
                    "水利局", "水务局",
                    "电力", "供电", "电网", "电力局",
                    "通信", "电信", "移动", "联通",
                    "发改委", "发展改革",
                    "机关事务", "后勤",
                ],
                # 活动特征词
                "activity_keywords": [
                    "公路", "道路", "桥梁", "隧道",
                    "供水", "排水", "供电", "供气", "供热", "管网",
                    "办公", "机关", "政府采购", "采购",
                    "网站", "软件", "系统开发", "系统集成",
                    "设计", "监理", "验收", "竣工",
                    "装修", "维修", "维护", "改建",
                    "车辆", "公务车", "办公家具", "办公设备",
                    "物业", "保洁", "绿化", "安保",
                    "租赁", "房屋租赁", "设备租赁",
                    "印刷", "出版", "图书",
                    "食堂", "餐饮", "配餐",
                    "技术服务", "技术开发", "技术咨询",
                    "设备", "仪器", "器材", "机械",
                    "展柜", "家具", "家电",
                ],
            },

            "合规能力": {
                "weight": 1.2,
                # 核心概念词
                "core_concepts": [
                    "教育", "教学", "培训", "学习",
                    "医疗", "卫生", "健康", "防疫",
                    "监督", "检查", "执法", "监察",
                    "服务", "保障", "救助", "扶贫",
                ],
                # 机构特征词
                "org_keywords": [
                    "学校", "大学", "学院", "中学", "小学", "幼儿园",
                    "医院", "卫生院", "诊所", "疾控", "血站",
                    "教育局", "教育厅", "教体局",
                    "卫生局", "卫健委", "卫生厅",
                    "公安局", "派出所", "消防", "武警",
                    "法院", "检察院", "司法局",
                    "市场监管", "质监", "药监", "食药监",
                    "民政", "残联", "老龄办",
                    "农业局", "农牧局", "林业局", "渔业局",
                ],
                # 活动特征词
                "activity_keywords": [
                    "教学设备", "实验室", "图书", "课桌", "教材",
                    "班班通", "多媒体", "电子白板",
                    "医疗设备", "药品", "器械", "诊断",
                    "CT", "核磁", "B超", "X光",
                    "执法装备", "警用", "安防", "监控",
                    "消防器材", "消防设备",
                    "培训项目", "考核", "评估",
                    "社保", "养老", "低保", "救灾",
                    "森林防火", "护林", "防火",
                    "牲畜", "耳标", "动物防疫", "兽医",
                    "文物保护", "文化遗产", "非物质文化遗产",
                    "考古", "博物馆", "纪念馆", "故宫",
                    "档案", "档案馆", "史志",
                    "保障房", "公租房", "廉租房", "棚户区",
                ],
            }
        }

    def _init_org_priority(self):
        """初始化机构优先级规则"""
        self.org_priority = {
            # 汲取能力机构 - 高优先级
            "税务": ("汲取能力", 5),
            "国税": ("汲取能力", 5),
            "地税": ("汲取能力", 5),
            "税务局": ("汲取能力", 5),
            "财政局": ("汲取能力", 4),
            "财政厅": ("汲取能力", 4),
            "海关": ("汲取能力", 5),
            "审计局": ("汲取能力", 4),
            "审计署": ("汲取能力", 4),
            "统计局": ("汲取能力", 4),
            "国土局": ("汲取能力", 3),
            "土地局": ("汲取能力", 3),
            "不动产": ("汲取能力", 3),
            "国资委": ("汲取能力", 3),

            # 合规能力机构 - 高优先级
            "学校": ("合规能力", 4),
            "大学": ("合规能力", 4),
            "学院": ("合规能力", 4),
            "中学": ("合规能力", 4),
            "小学": ("合规能力", 4),
            "幼儿园": ("合规能力", 4),
            "医院": ("合规能力", 4),
            "卫生院": ("合规能力", 4),
            "诊所": ("合规能力", 3),
            "疾控": ("合规能力", 4),
            "教育局": ("合规能力", 4),
            "教育厅": ("合规能力", 4),
            "卫生局": ("合规能力", 4),
            "卫健委": ("合规能力", 4),
            "公安局": ("合规能力", 4),
            "公安": ("合规能力", 4),
            "派出所": ("合规能力", 4),
            "消防": ("合规能力", 4),
            "法院": ("合规能力", 4),
            "检察院": ("合规能力", 4),
            "司法局": ("合规能力", 3),
            "民政局": ("合规能力", 3),
            "农业局": ("合规能力", 3),
            "农牧局": ("合规能力", 3),
            "林业局": ("合规能力", 3),
            "文物局": ("合规能力", 3),
            "博物馆": ("合规能力", 3),
            "故宫": ("合规能力", 4),

            # 协调能力机构
            "交通局": ("协调能力", 3),
            "交通": ("协调能力", 2),
            "公路局": ("协调能力", 3),
            "水利局": ("协调能力", 3),
            "水务局": ("协调能力", 3),
            "电力局": ("协调能力", 3),
            "供电": ("协调能力", 3),
            "建设局": ("协调能力", 3),
            "住建局": ("协调能力", 3),
            "规划局": ("协调能力", 3),
            "机关事务": ("协调能力", 3),
            "后勤": ("协调能力", 2),
        }

    def _init_project_modifiers(self):
        """初始化项目类型修正规则"""
        self.project_modifiers = {
            # 增加协调能力得分
            "建设工程": {"协调能力": 3},
            "改造工程": {"协调能力": 3},
            "施工项目": {"协调能力": 3},
            "工程项目": {"协调能力": 2},
            "基建项目": {"协调能力": 2},
            "信息化项目": {"协调能力": 2},
            "采购项目": {"协调能力": 1},
            "设备采购": {"协调能力": 1},
            "货物采购": {"协调能力": 1},
            "办公采购": {"协调能力": 1},
            "技术服务": {"协调能力": 1},
            "技术开发": {"协调能力": 1},
            "维修项目": {"协调能力": 1},
            "租赁": {"协调能力": 1},

            # 增加合规能力得分
            "培训项目": {"合规能力": 3},
            "教育项目": {"合规能力": 3},
            "医疗项目": {"合规能力": 3},
            "服务项目": {"合规能力": 1},
            "防火": {"合规能力": 2},
            "护林": {"合规能力": 2},
            "防疫": {"合规能力": 2},
            "扶贫": {"合规能力": 2},
            "文物保护": {"合规能力": 2},
        }

    def label(self, text):
        """
        对单条合同进行LLM语义标注
        返回: (标签, 置信度, 匹配详情)
        """
        if pd.isna(text) or not text:
            return "协调能力", 0.33, {"reason": "空文本默认分类"}

        text = str(text)
        scores = {"汲取能力": 0, "协调能力": 0, "合规能力": 0}
        details = {"org_matches": [], "core_matches": [], "activity_matches": []}

        # 第1层：机构识别（最高优先级）
        for org_keyword, (capacity, weight) in self.org_priority.items():
            if org_keyword in text:
                scores[capacity] += weight
                details["org_matches"].append(f"{org_keyword}→{capacity}(+{weight})")

        # 第2层：核心概念匹配
        for capacity, rules in self.semantic_rules.items():
            cap_weight = rules["weight"]

            for word in rules["core_concepts"]:
                if word in text:
                    scores[capacity] += 2 * cap_weight
                    details["core_matches"].append(f"{word}→{capacity}")

            # 第3层：机构特征匹配
            for word in rules["org_keywords"]:
                if word in text:
                    scores[capacity] += 1.5 * cap_weight

            # 第4层：活动特征匹配
            for word in rules["activity_keywords"]:
                if word in text:
                    scores[capacity] += 1 * cap_weight
                    details["activity_matches"].append(f"{word}→{capacity}")

        # 第5层：项目类型修正
        for proj_type, modifiers in self.project_modifiers.items():
            if proj_type in text:
                for cap, mod_weight in modifiers.items():
                    scores[cap] += mod_weight

        # 计算最终结果
        total = sum(scores.values())
        if total == 0:
            # 使用兜底规则
            text_str = str(text)

            # 1. 先尝试具体的兜底规则
            for capacity, keywords in FALLBACK_RULES.items():
                for kw in keywords:
                    if kw in text_str:
                        return capacity, 0.5, {"reason": f"兜底规则: {kw}"}

            # 2. 设备仪器类兜底
            for kw in EQUIPMENT_FALLBACK_KEYWORDS:
                if kw in text_str:
                    return "协调能力", 0.5, {"reason": f"设备仪器兜底: {kw}"}
            # 3. 服务类兜底
            for kw in SERVICE_FALLBACK_KEYWORDS:
                if kw in text_str:
                    return "协调能力", 0.5, {"reason": f"服务类兜底: {kw}"}
            # 4. 物资货物类兜底
            for kw in MATERIAL_FALLBACK_KEYWORDS:
                if kw in text_str:
                    return "协调能力", 0.5, {"reason": f"物资货物兜底: {kw}"}
            # 5. 极端兜底（合同相关词）
            for kw in ULTIMATE_FALLBACK_KEYWORDS:
                if kw in text_str:
                    return "协调能力", 0.5, {"reason": f"合同兜底: {kw}"}
            # 6. 最终兜底：任何未匹配的都归为协调能力
            return "协调能力", 0.4, {"reason": "无匹配关键词，默认分类"}

        max_capacity = max(scores, key=scores.get)
        confidence = scores[max_capacity] / total

        # 如果最高分和次高分接近，降低置信度
        sorted_scores = sorted(scores.values(), reverse=True)
        if len(sorted_scores) >= 2 and sorted_scores[0] > 0:
            margin = (sorted_scores[0] - sorted_scores[1]) / sorted_scores[0]
            if margin < 0.3:
                confidence *= 0.8

        details["scores"] = scores
        details["reason"] = f"综合得分: {scores}"

        return max_capacity, confidence, details

    def label_batch(self, texts, show_progress=True):
        """批量标注"""
        results = []
        total = len(texts)

        for idx, text in enumerate(texts):
            label, conf, details = self.label(text)
            results.append({
                "text": text,
                "label": label,
                "confidence": conf,
                "details": details
            })

            if show_progress and (idx + 1) % 5000 == 0:
                print(f"  已标注: {idx + 1}/{total}")

        return results


# ============================================================
# 分词器（模块级别定义，支持pickle）
# ============================================================

def simple_tokenizer(text):
    """简单的中文分词器（字符级 + bigram）"""
    if not text or pd.isna(text):
        return []
    text = str(text)
    chars = list(text)
    bigrams = [text[i:i+2] for i in range(len(text)-1)]
    return chars + bigrams


# ============================================================
# 对比两个方案
# ============================================================

def compare_approaches(data_path, text_column="合同名称"):
    """对比两个方案的效果"""
    print("=" * 70)
    print("增强版国家能力合同分类器 - 方案对比")
    print("=" * 70)

    # 加载数据
    print("\n加载数据...")
    if data_path.endswith('.xlsx'):
        df = pd.read_excel(data_path)
    else:
        df = pd.read_excel(data_path)
    print(f"数据集大小: {len(df)} 条")

    texts = df[text_column].tolist()

    # 方案1：增强关键词规则
    print("\n" + "=" * 70)
    print("方案1：增强关键词规则方法")
    print("=" * 70)

    rule_labeler = EnhancedRuleLabeler()
    rule_results = rule_labeler.label_batch(texts)

    # 统计方案1结果
    rule_labels = [r["label"] for r in rule_results]
    rule_confs = [r["confidence"] for r in rule_results]

    print("\n方案1 标注分布:")
    for label in ["汲取能力", "协调能力", "合规能力"]:
        count = rule_labels.count(label)
        print(f"  {label}: {count} ({count/len(rule_labels)*100:.1f}%)")

    print(f"\n方案1 平均置信度: {np.mean(rule_confs):.3f}")

    # 计算覆盖率（有明确关键词匹配的比例）
    covered = sum(1 for r in rule_results if r["confidence"] > 0.33)
    print(f"方案1 覆盖率: {covered/len(rule_results)*100:.1f}%")

    # 方案2：增强LLM语义规则
    print("\n" + "=" * 70)
    print("方案2：增强LLM语义规则方法")
    print("=" * 70)

    llm_labeler = EnhancedLLMLabeler()
    llm_results = llm_labeler.label_batch(texts)

    # 统计方案2结果
    llm_labels = [r["label"] for r in llm_results]
    llm_confs = [r["confidence"] for r in llm_results]

    print("\n方案2 标注分布:")
    for label in ["汲取能力", "协调能力", "合规能力"]:
        count = llm_labels.count(label)
        print(f"  {label}: {count} ({count/len(llm_labels)*100:.1f}%)")

    print(f"\n方案2 平均置信度: {np.mean(llm_confs):.3f}")

    # 计算覆盖率
    covered = sum(1 for r in llm_results if r["confidence"] > 0.33)
    print(f"方案2 覆盖率: {covered/len(llm_results)*100:.1f}%")

    # 两个方案的一致性分析
    print("\n" + "=" * 70)
    print("两个方案的一致性分析")
    print("=" * 70)

    consistent = sum(1 for r1, r2 in zip(rule_labels, llm_labels) if r1 == r2)
    print(f"一致率: {consistent/len(rule_labels)*100:.1f}%")

    # 分析分歧样本
    print("\n分歧样本示例 (前10个):")
    count = 0
    for i, (r1, r2) in enumerate(zip(rule_results, llm_results)):
        if r1["label"] != r2["label"]:
            count += 1
            if count <= 10:
                print(f"\n  {count}. {r1['text'][:60]}...")
                print(f"     方案1: {r1['label']} (置信度: {r1['confidence']:.2f})")
                print(f"     方案2: {r2['label']} (置信度: {r2['confidence']:.2f})")

    # 保存结果
    print("\n" + "=" * 70)
    print("保存结果")
    print("=" * 70)

    result_df = df.copy()
    result_df["方案1_标签"] = rule_labels
    result_df["方案1_置信度"] = rule_confs
    result_df["方案2_标签"] = llm_labels
    result_df["方案2_置信度"] = llm_confs
    result_df["两方案一致"] = [r1 == r2 for r1, r2 in zip(rule_labels, llm_labels)]

    output_path = data_path.replace(".xls", "_增强分类对比.xlsx")
    result_df.to_excel(output_path, index=False)
    print(f"结果已保存: {output_path}")

    return rule_results, llm_results, result_df


# ============================================================
# 主程序
# ============================================================

if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1:
        data_path = sys.argv[1]
    else:
        data_path = "/home/user/MOR-SI/2015.xls"

    compare_approaches(data_path)
